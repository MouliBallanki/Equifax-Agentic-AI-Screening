<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tenant Screening - Application</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            color: #333;
            min-height: 100vh;
        }

        /* ===== Header ===== */
        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: white;
            padding: 24px 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .logo-icon {
            width: 48px; height: 48px;
            background: linear-gradient(135deg, #e94560, #c23152);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; font-weight: 700;
        }
        .header h1 { font-size: 22px; font-weight: 600; letter-spacing: .5px; }
        .header p  { font-size: 13px; opacity: .75; margin-top: 2px; }
        .header-badge {
            background: rgba(233,69,96,.2);
            border: 1px solid rgba(233,69,96,.4);
            color: #ff6b8a;
            padding: 6px 16px; border-radius: 20px;
            font-size: 12px; font-weight: 600; letter-spacing: .5px;
        }

        /* ===== Container ===== */
        .container { max-width: 860px; margin: 32px auto; padding: 0 20px 40px; }

        /* ===== Progress Bar ===== */
        .progress-bar {
            display: flex; justify-content: space-between;
            margin-bottom: 32px; position: relative;
        }
        .progress-bar::before {
            content: ''; position: absolute; top: 20px;
            left: 60px; right: 60px; height: 3px; background: #ddd; z-index: 0;
        }
        .progress-step {
            display: flex; flex-direction: column; align-items: center;
            gap: 8px; z-index: 1; cursor: pointer;
        }
        .step-circle {
            width: 40px; height: 40px; border-radius: 50%;
            background: #ddd; color: #888;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 14px; transition: all .3s ease;
        }
        .step-circle.active {
            background: linear-gradient(135deg, #e94560, #c23152);
            color: white; box-shadow: 0 4px 15px rgba(233,69,96,.4);
        }
        .step-circle.completed { background: #27ae60; color: white; }
        .step-label { font-size: 12px; font-weight: 500; color: #888; transition: color .3s; }
        .step-label.active  { color: #e94560; font-weight: 600; }
        .step-label.completed { color: #27ae60; }

        /* ===== Sections ===== */
        .section {
            background: white; border-radius: 16px; padding: 32px;
            margin-bottom: 24px; box-shadow: 0 2px 12px rgba(0,0,0,.06);
            display: none; animation: fadeIn .4s ease;
        }
        .section.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(12px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            display: flex; align-items: center; gap: 12px;
            margin-bottom: 28px; padding-bottom: 16px; border-bottom: 2px solid #f0f2f5;
        }
        .section-icon {
            width: 44px; height: 44px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; font-size: 22px;
        }
        .section-icon.personal   { background: #eef2ff; }
        .section-icon.employment { background: #fef3e2; }
        .section-icon.rental     { background: #e8f8f0; }
        .section-icon.additional { background: #fce8ec; }
        .section-header h2   { font-size: 20px; font-weight: 600; color: #1a1a2e; }
        .section-header span { font-size: 13px; color: #999; }

        /* ===== Form Layout ===== */
        .form-row       { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 4px; }
        .form-row.three { grid-template-columns: 2fr 1fr 1fr; }
        .form-group      { margin-bottom: 18px; }
        .form-group.full { grid-column: 1 / -1; }

        .form-group label {
            display: block; font-size: 13px; font-weight: 600;
            color: #555; margin-bottom: 6px; letter-spacing: .3px;
        }
        .form-group label .req  { color: #e94560; margin-left: 2px; }
        .form-group label .opt  { color: #aaa; font-weight: 400; font-size: 11px; margin-left: 4px; }

        .form-group input,
        .form-group select {
            width: 100%; padding: 11px 14px;
            border: 2px solid #e8e8e8; border-radius: 10px;
            font-size: 14px; font-family: inherit; color: #333;
            transition: all .2s ease; background: #fafafa;
        }
        .form-group input:focus,
        .form-group select:focus {
            outline: none; border-color: #e94560; background: white;
            box-shadow: 0 0 0 4px rgba(233,69,96,.08);
        }
        .form-group input::placeholder { color: #bbb; }
        .form-group input.error,
        .form-group select.error { border-color: #e74c3c; background: #fff5f5; }
        .form-group .error-msg { color: #e74c3c; font-size: 12px; margin-top: 4px; display: none; }
        .form-group input.error ~ .error-msg,
        .form-group select.error ~ .error-msg { display: block; }

        /* ===== Toggle Switches ===== */
        .toggle-group { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .toggle-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 20px; background: #f8f9fa; border-radius: 12px;
            border: 2px solid #eee; transition: all .2s;
        }
        .toggle-item:hover { border-color: #ddd; background: #f0f2f5; }
        .toggle-item span  { font-size: 14px; font-weight: 500; color: #444; }

        .toggle-switch { position: relative; width: 48px; height: 26px; cursor: pointer; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute; inset: 0; background: #ccc;
            border-radius: 26px; transition: .3s;
        }
        .toggle-slider::before {
            content: ''; position: absolute; height: 20px; width: 20px;
            left: 3px; bottom: 3px; background: white;
            border-radius: 50%; transition: .3s;
        }
        .toggle-switch input:checked + .toggle-slider { background: #e94560; }
        .toggle-switch input:checked + .toggle-slider::before { transform: translateX(22px); }

        /* ===== Buttons ===== */
        .btn-row { display: flex; justify-content: space-between; margin-top: 8px; }
        .btn {
            padding: 12px 32px; border: none; border-radius: 10px;
            font-size: 15px; font-weight: 600; cursor: pointer;
            transition: all .2s; font-family: inherit;
        }
        .btn-back { background: #f0f2f5; color: #666; }
        .btn-back:hover { background: #e0e3e8; }
        .btn-next {
            background: linear-gradient(135deg, #e94560, #c23152); color: white;
            box-shadow: 0 4px 15px rgba(233,69,96,.3);
        }
        .btn-next:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(233,69,96,.4); }
        .btn-submit {
            background: linear-gradient(135deg, #27ae60, #219a52); color: white;
            padding: 14px 40px; font-size: 16px;
            box-shadow: 0 4px 15px rgba(39,174,96,.3);
        }
        .btn-submit:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(39,174,96,.4); }
        .btn:disabled { opacity: .6; cursor: not-allowed; transform: none !important; }

        /* ===== Modal ===== */
        .modal-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,.5); z-index: 1000;
            align-items: center; justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: white; border-radius: 20px; padding: 40px;
            max-width: 480px; width: 90%; text-align: center;
            animation: modalIn .3s ease;
        }
        @keyframes modalIn {
            from { opacity: 0; transform: scale(.9); }
            to   { opacity: 1; transform: scale(1); }
        }
        .modal .icon-wrap {
            width: 72px; height: 72px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 36px; margin: 0 auto 20px; color: white;
        }
        .modal .icon-wrap.success { background: linear-gradient(135deg, #27ae60, #219a52); }
        .modal .icon-wrap.fail    { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .modal h3 { font-size: 22px; margin-bottom: 8px; color: #1a1a2e; }
        .modal p  { color: #666; font-size: 14px; line-height: 1.6; }
        .modal .app-id {
            background: #f0f2f5; border-radius: 8px; padding: 12px; margin: 16px 0;
            font-family: 'Courier New', monospace; font-size: 13px;
            color: #e94560; font-weight: 600; word-break: break-all;
        }
        .modal .btn { margin-top: 20px; }

        .spinner {
            display: inline-block; width: 20px; height: 20px;
            border: 3px solid rgba(255,255,255,.3); border-radius: 50%;
            border-top-color: white; animation: spin .8s linear infinite;
            margin-right: 8px; vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ===== Responsive ===== */
        @media (max-width: 640px) {
            .header { padding: 16px 20px; }
            .header h1 { font-size: 18px; }
            .header-badge { display: none; }
            .container { padding: 0 12px 32px; }
            .section { padding: 24px 20px; }
            .form-row, .form-row.three { grid-template-columns: 1fr; }
            .toggle-group { grid-template-columns: 1fr; }
            .progress-bar::before { left: 30px; right: 30px; }
            .step-label { font-size: 10px; }
        }
    </style>
</head>
<body>

<style>
    .header-right{display:flex;align-items:center;gap:20px}
    .user-greeting{font-size:14px;font-weight:500;color:rgba(255,255,255,.85)}
    .user-greeting strong{color:#ff6b8a}
    .header-btn{padding:8px 18px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:none;font-family:inherit;transition:all .2s}
    .btn-apps{background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.2)}
    .btn-apps:hover{background:rgba(255,255,255,.2)}
    .btn-logout{background:rgba(233,69,96,.2);color:#ff6b8a;border:1px solid rgba(233,69,96,.3)}
    .btn-logout:hover{background:rgba(233,69,96,.35)}
</style>

<div class="header">
    <div class="header-left">
        <div class="logo-icon" onclick="location.href='/'">E</div>
        <div>
            <h1>Tenant Screening Application</h1>
            <p>AI-Powered Screening Platform</p>
        </div>
    </div>
    <div class="header-right">
        <span class="user-greeting">Hi, <strong id="headerName"></strong></span>
        <button class="header-btn btn-apps" onclick="location.href='/'">My Applications</button>
        <button class="header-btn btn-logout" onclick="localStorage.clear();location.href='/signin'">Logout</button>
    </div>
</div>

<div class="container">

    <!-- Progress Bar -->
    <div class="progress-bar">
        <div class="progress-step" onclick="goToStep(0)">
            <div class="step-circle active" id="sc-0">1</div>
            <div class="step-label active" id="sl-0">Personal Info</div>
        </div>
        <div class="progress-step" onclick="goToStep(1)">
            <div class="step-circle" id="sc-1">2</div>
            <div class="step-label" id="sl-1">Employment</div>
        </div>
        <div class="progress-step" onclick="goToStep(2)">
            <div class="step-circle" id="sc-2">3</div>
            <div class="step-label" id="sl-2">Rental History</div>
        </div>
        <div class="progress-step" onclick="goToStep(3)">
            <div class="step-circle" id="sc-3">4</div>
            <div class="step-label" id="sl-3">Submit</div>
        </div>
    </div>

    <form id="appForm" novalidate>

        <!-- ========== Section 1: Personal Info ========== -->
        <div class="section active" id="sec-0">
            <div class="section-header">
                <div class="section-icon personal">&#128100;</div>
                <div><h2>Personal Information</h2><span>Applicant's basic details</span></div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>First Name <span class="req">*</span></label>
                    <input type="text" id="first_name" placeholder="John" required>
                    <div class="error-msg">First name is required</div>
                </div>
                <div class="form-group">
                    <label>Last Name <span class="req">*</span></label>
                    <input type="text" id="last_name" placeholder="Doe" required>
                    <div class="error-msg">Last name is required</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Email Address <span class="req">*</span></label>
                    <input type="email" id="email" placeholder="john.doe@email.com" required>
                    <div class="error-msg">Valid email is required</div>
                </div>
                <div class="form-group">
                    <label>Phone Number <span class="req">*</span></label>
                    <input type="tel" id="phone" placeholder="555-0199" required>
                    <div class="error-msg">Phone number is required</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>SSN <span class="req">*</span></label>
                    <input type="text" id="ssn" placeholder="000-00-0000" maxlength="11" required>
                    <div class="error-msg">SSN required (000-00-0000)</div>
                </div>
                <div class="form-group">
                    <label>Date of Birth <span class="req">*</span></label>
                    <input type="date" id="dob" required>
                    <div class="error-msg">Date of birth is required</div>
                </div>
            </div>

            <div class="form-group">
                <label>Street Address <span class="req">*</span></label>
                <input type="text" id="street" placeholder="456 Oak Avenue" required>
                <div class="error-msg">Street address is required</div>
            </div>

            <div class="form-row three">
                <div class="form-group">
                    <label>City <span class="req">*</span></label>
                    <input type="text" id="city" placeholder="New York" required>
                    <div class="error-msg">City is required</div>
                </div>
                <div class="form-group">
                    <label>State <span class="req">*</span></label>
                    <select id="state" required>
                        <option value="">Select</option>
                        <option>AL</option><option>AK</option><option>AZ</option><option>AR</option>
                        <option>CA</option><option>CO</option><option>CT</option><option>DE</option>
                        <option>FL</option><option>GA</option><option>HI</option><option>ID</option>
                        <option>IL</option><option>IN</option><option>IA</option><option>KS</option>
                        <option>KY</option><option>LA</option><option>ME</option><option>MD</option>
                        <option>MA</option><option>MI</option><option>MN</option><option>MS</option>
                        <option>MO</option><option>MT</option><option>NE</option><option>NV</option>
                        <option>NH</option><option>NJ</option><option>NM</option><option>NY</option>
                        <option>NC</option><option>ND</option><option>OH</option><option>OK</option>
                        <option>OR</option><option>PA</option><option>RI</option><option>SC</option>
                        <option>SD</option><option>TN</option><option>TX</option><option>UT</option>
                        <option>VT</option><option>VA</option><option>WA</option><option>WV</option>
                        <option>WI</option><option>WY</option><option>DC</option>
                    </select>
                    <div class="error-msg">State is required</div>
                </div>
                <div class="form-group">
                    <label>ZIP Code <span class="req">*</span></label>
                    <input type="text" id="zip" placeholder="10001" maxlength="10" required>
                    <div class="error-msg">ZIP is required</div>
                </div>
            </div>

            <div class="btn-row">
                <div></div>
                <button type="button" class="btn btn-next" onclick="nextStep(0)">Next &rarr;</button>
            </div>
        </div>

        <!-- ========== Section 2: Employment ========== -->
        <div class="section" id="sec-1">
            <div class="section-header">
                <div class="section-icon employment">&#128188;</div>
                <div><h2>Employment Details</h2><span>Current employment information</span></div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Employer Name <span class="req">*</span></label>
                    <input type="text" id="employer_name" placeholder="Tech Solutions Inc" required>
                    <div class="error-msg">Employer name is required</div>
                </div>
                <div class="form-group">
                    <label>Job Title <span class="req">*</span></label>
                    <input type="text" id="job_title" placeholder="Software Engineer" required>
                    <div class="error-msg">Job title is required</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Employment Status <span class="req">*</span></label>
                    <select id="employment_status" required>
                        <option value="">Select Status</option>
                        <option value="full-time">Full-Time</option>
                        <option value="part-time">Part-Time</option>
                        <option value="self-employed">Self-Employed</option>
                        <option value="contract">Contract</option>
                    </select>
                    <div class="error-msg">Employment status is required</div>
                </div>
                <div class="form-group">
                    <label>Employer Phone <span class="req">*</span></label>
                    <input type="tel" id="employer_phone" placeholder="555-0100" required>
                    <div class="error-msg">Employer phone is required</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Annual Income ($) <span class="req">*</span></label>
                    <input type="number" id="annual_income" placeholder="90000" min="0" step="100" required>
                    <div class="error-msg">Annual income is required</div>
                </div>
                <div class="form-group">
                    <label>Years Employed <span class="req">*</span></label>
                    <input type="number" id="years_employed" placeholder="5.5" min="0" step="0.1" required>
                    <div class="error-msg">Years employed is required</div>
                </div>
            </div>

            <div class="btn-row">
                <button type="button" class="btn btn-back" onclick="prevStep(1)">&larr; Back</button>
                <button type="button" class="btn btn-next" onclick="nextStep(1)">Next &rarr;</button>
            </div>
        </div>

        <!-- ========== Section 3: Rental History ========== -->
        <div class="section" id="sec-2">
            <div class="section-header">
                <div class="section-icon rental">&#127968;</div>
                <div><h2>Rental History</h2><span>Previous rental information <span class="opt">(all optional)</span></span></div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Current Landlord <span class="opt">(optional)</span></label>
                    <input type="text" id="current_landlord" placeholder="Brooklyn Property Mgmt">
                </div>
                <div class="form-group">
                    <label>Landlord Phone <span class="opt">(optional)</span></label>
                    <input type="tel" id="current_landlord_phone" placeholder="555-0100">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Monthly Rent ($) <span class="opt">(optional)</span></label>
                    <input type="number" id="monthly_rent" placeholder="2000" min="0" step="50">
                </div>
                <div class="form-group">
                    <label>Years at Current Address <span class="opt">(optional)</span></label>
                    <input type="number" id="years_at_current" placeholder="3" min="0" step="0.1">
                </div>
            </div>

            <div class="form-group">
                <label>Reason for Leaving <span class="opt">(optional)</span></label>
                <select id="reason_for_leaving">
                    <option value="">Select a reason</option>
                    <option value="Moving for work">Moving for work</option>
                    <option value="Seeking larger space">Seeking larger space</option>
                    <option value="Closer to family">Closer to family</option>
                    <option value="Better neighborhood">Better neighborhood</option>
                    <option value="End of lease">End of lease</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="btn-row">
                <button type="button" class="btn btn-back" onclick="prevStep(2)">&larr; Back</button>
                <button type="button" class="btn btn-next" onclick="nextStep(2)">Next &rarr;</button>
            </div>
        </div>

        <!-- ========== Section 4: Additional Info ========== -->
        <div class="section" id="sec-3">
            <div class="section-header">
                <div class="section-icon additional">&#128203;</div>
                <div><h2>Additional Information</h2><span>Disclosure questions</span></div>
            </div>

            <div class="toggle-group">
                <div class="toggle-item">
                    <span>Do you have pets?</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="pets">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="toggle-item">
                    <span>Are you a smoker?</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="smoker">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="toggle-item">
                    <span>Bankruptcy history?</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="bankruptcy_history">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="toggle-item">
                    <span>Eviction history?</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="eviction_history">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div class="btn-row" style="margin-top:28px">
                <button type="button" class="btn btn-back" onclick="prevStep(3)">&larr; Back</button>
                <button type="button" class="btn btn-submit" id="submitBtn" onclick="submitForm()">
                    Submit Application
                </button>
            </div>
        </div>

    </form>
</div>

<!-- Result Modal -->
<div class="modal-overlay" id="modal">
    <div class="modal">
        <div class="icon-wrap" id="modalIcon"></div>
        <h3 id="modalTitle"></h3>
        <p id="modalMsg"></p>
        <div class="app-id" id="modalAppId" style="display:none"></div>
        <button class="btn btn-next" onclick="closeModal()" id="modalOkBtn">OK</button>
    </div>
</div>

<script>
    /* ---- Auth guard ---- */
    const _token = localStorage.getItem('token');
    if (!_token) location.href = '/signin';
    document.getElementById('headerName').textContent = localStorage.getItem('first_name') || 'User';

    /* ---- One-application guard ---- */
    (async function checkExisting() {
        try {
            const res = await fetch('/api/v1/applications/my', {
                headers: { 'Authorization': 'Bearer ' + _token }
            });
            if (res.ok) {
                const data = await res.json();
                if (data.applications && data.applications.length > 0) {
                    location.href = '/';
                }
            }
        } catch (e) {}
    })();
    
    /* ---- Pre-fill user info from localStorage or API ---- */
    (async function prefillUserInfo() {
        // Try to get from localStorage first
        let firstName = localStorage.getItem('first_name');
        let lastName = localStorage.getItem('last_name');
        let email = localStorage.getItem('email');
        
        // If last_name is missing (old session), fetch from API
        if (!lastName && _token) {
            try {
                const res = await fetch('/api/v1/auth/me', {
                    headers: { 'Authorization': 'Bearer ' + _token }
                });
                if (res.ok) {
                    const data = await res.json();
                    firstName = data.first_name;
                    lastName = data.last_name;
                    email = data.email;
                    
                    // Update localStorage
                    localStorage.setItem('first_name', firstName);
                    localStorage.setItem('last_name', lastName);
                    localStorage.setItem('email', email);
                }
            } catch (e) {
                console.error('Failed to fetch user info:', e);
            }
        }
        
        // Pre-fill the form fields
        if (firstName) document.getElementById('first_name').value = firstName;
        if (lastName) document.getElementById('last_name').value = lastName;
        if (email) document.getElementById('email').value = email;
    })();

    let currentStep = 0;
    const totalSteps = 4;

    const requiredFields = {
        0: ['first_name','last_name','email','phone','ssn','dob','street','city','state','zip'],
        1: ['employer_name','job_title','employment_status','employer_phone','annual_income','years_employed'],
        2: [],
        3: []
    };

    /* ---- SSN auto-format ---- */
    document.getElementById('ssn').addEventListener('input', function(e) {
        let v = e.target.value.replace(/\D/g, '');
        if (v.length > 3 && v.length <= 5) v = v.slice(0,3) + '-' + v.slice(3);
        else if (v.length > 5) v = v.slice(0,3) + '-' + v.slice(3,5) + '-' + v.slice(5,9);
        e.target.value = v;
    });

    /* ---- Navigation ---- */
    function updateProgress() {
        for (let i = 0; i < totalSteps; i++) {
            const circle = document.getElementById('sc-' + i);
            const label  = document.getElementById('sl-' + i);
            const sec    = document.getElementById('sec-' + i);

            circle.classList.remove('active','completed');
            label.classList.remove('active','completed');
            sec.classList.remove('active');

            if (i < currentStep)       { circle.classList.add('completed'); label.classList.add('completed'); circle.textContent = '\u2713'; }
            else if (i === currentStep) { circle.classList.add('active');    label.classList.add('active');    circle.textContent = i + 1;     sec.classList.add('active'); }
            else                        { circle.textContent = i + 1; }
        }
    }

    function validateStep(step) {
        let valid = true;
        requiredFields[step].forEach(id => {
            const el = document.getElementById(id);
            const val = el.value.trim();
            if (!val) { el.classList.add('error'); valid = false; }
            else      { el.classList.remove('error'); }
        });
        if (!valid) {
            const firstErr = document.querySelector('#sec-' + step + ' .error');
            if (firstErr) firstErr.focus();
        }
        return valid;
    }

    function nextStep(step) {
        if (!validateStep(step)) return;
        currentStep = step + 1;
        updateProgress();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function prevStep(step) {
        currentStep = step - 1;
        updateProgress();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function goToStep(step) {
        if (step > currentStep) return;
        currentStep = step;
        updateProgress();
    }

    /* ---- Clear error on input ---- */
    document.querySelectorAll('input, select').forEach(el => {
        el.addEventListener('input', () => el.classList.remove('error'));
        el.addEventListener('change', () => el.classList.remove('error'));
    });

    /* ---- Submit ---- */
    async function submitForm() {
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Submitting...';

        const val = id => document.getElementById(id).value.trim();
        const num = id => parseFloat(document.getElementById(id).value) || null;
        const chk = id => document.getElementById(id).checked;

        const payload = {
            applicant: {
                first_name: val('first_name'),
                last_name:  val('last_name'),
                email:      val('email'),
                phone:      val('phone'),
                ssn:        val('ssn'),
                date_of_birth: val('dob'),
                current_address: {
                    street: val('street'),
                    city:   val('city'),
                    state:  val('state'),
                    zip:    val('zip')
                }
            },
            employment: {
                employer_name:     val('employer_name'),
                job_title:         val('job_title'),
                employment_status: val('employment_status'),
                annual_income:     num('annual_income'),
                years_employed:    num('years_employed'),
                employer_phone:    val('employer_phone')
            },
            rental_history: {
                current_landlord:       val('current_landlord') || null,
                current_landlord_phone: val('current_landlord_phone') || null,
                monthly_rent:           num('monthly_rent'),
                years_at_current:       num('years_at_current'),
                reason_for_leaving:     val('reason_for_leaving') || null
            },
            additional_info: {
                pets:               chk('pets'),
                smoker:             chk('smoker'),
                bankruptcy_history: chk('bankruptcy_history'),
                eviction_history:   chk('eviction_history')
            }
        };

        try {
            const headers = { 'Content-Type': 'application/json' };
            if (_token) headers['Authorization'] = 'Bearer ' + _token;

            const res  = await fetch('/api/v1/applications/submit-to-db', {
                method: 'POST',
                headers,
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            if (res.ok) {
                showModal(true, 'Application Submitted!',
                    'Your application has been received and queued for AI screening.',
                    data.application_id);
            } else {
                showModal(false, 'Submission Failed', data.detail || 'Something went wrong. Please try again.');
            }
        } catch (err) {
            showModal(false, 'Network Error', 'Could not connect to the server. Please check if the API is running.');
        }

        btn.disabled = false;
        btn.innerHTML = 'Submit Application';
    }

    /* ---- Modal ---- */
    let _modalSuccess = false;

    function showModal(success, title, msg, appId) {
        _modalSuccess = success;
        document.getElementById('modalIcon').className  = 'icon-wrap ' + (success ? 'success' : 'fail');
        document.getElementById('modalIcon').textContent = success ? '\u2713' : '\u2717';
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalMsg').textContent   = msg;
        document.getElementById('modalOkBtn').textContent = success ? 'Go to Dashboard' : 'OK';

        const idEl = document.getElementById('modalAppId');
        if (appId) { idEl.textContent = 'Application ID: ' + appId; idEl.style.display = 'block'; }
        else       { idEl.style.display = 'none'; }

        document.getElementById('modal').classList.add('show');
    }

    function closeModal() {
        document.getElementById('modal').classList.remove('show');
        if (_modalSuccess) location.href = '/';
    }
</script>

</body>
</html>
